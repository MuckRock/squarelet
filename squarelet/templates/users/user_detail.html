{% extends "base.html" %}
{% load static %}
{% load thumbnail %}
{% load avatar %}
{% load i18n %}

{% block title %}{% trans 'User' %}: {{ user.username }}{% endblock %}

{% block css %}
{# shared styles #}
<link rel="stylesheet" href="{% static "css/gps.css" %}" />
<link rel="stylesheet" href="{% static "css/invites.css" %}" />


{# include any style tags in parent tempaltes #}
{{ block.super }}

{# page-specific styles #}
<link rel="stylesheet" href="{% static "css/user_detail.css" %}" />
{% endblock css %}

{% block content %}
<main id="user_detail">
  <aside class="sidebar">
    <div class="account">
      <h2>{% trans "Your Account" %}</h2>
      <nav>
        <ul>
          <li class="profile nav-item">
            <a href="#profile">
              {% include "core/icons/person.svg" %}
              {% trans "Profile" %}
            </a>
          </li>
          <li class="verification nav-item">
            <a href="#verification">
              {% include "core/icons/verification.svg" %}
              {% trans "Verification" %}
            </a>
          </li>
          <li class="organization nav-item">
            <a href="#organizations">
              {% include "core/icons/organization.svg" %}
              {% trans "Organizations" %}
            </a>
          </li>
          <li class="accounts nav-item">
            <a href="#accounts">
              {% include "core/icons/mention.svg" %}
              {% trans "Accounts" %}
            </a>
          </li>
          <li class="security nav-item">
            <a href="#security">
              {% include "core/icons/shield-lock.svg" %}
              {% trans "Security" %}
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <div class="content">
    <section id="profile">
      <header>
        <h2>{% trans "Your Profile" %}</h2>
        <a href="?public" class="btn ghost">
          {% include "core/icons/eye.svg" %}
          {% trans "View profile" %}
        </a>
        <a href="{% url "users:update" %}" class="btn ghost">
          {% include "core/icons/pencil.svg" %}
          {% trans "Edit profile" %}
        </a>
      </header>
      <div class="profile">
        <div class="icon">
        {% if user.avatar %}
          <img src="{{ user.avatar.url }}" alt="{{user.name}}" />
        {% else %}
          {% include "core/icons/person.svg" %}
        {% endif %}
        </div>

        <div class="details">
          <h3>{{ user.name }}</h3>
          <div class="reputation">
            {# need to add an active org setting #}
          </div>
        </div>
      </div>
    </section>

    <section id="verification">
      <header>
        <h2>{% trans "Your Verification" %}</h2>
        <a href="#" class="btn ghost">
          {% include "core/icons/book.svg" %}
          {% trans "Learn about verification" %}
        </a>
      </header>

      <div class="verification-status">
        {% if verified %}
        <div class="status verified">
          {% include "core/icons/verification.svg" %}
          <h3>{% trans "You are a verified journalist." %}</h3>
        </div>
        <dl class="features">
          <dt class="checklist-item">{% include "core/icons/unlock.svg" %}{% trans "Unlocked features:" %}</dt>
          <dd class="checklist-item">{% include "core/icons/check-circle-fill.svg" %}{% trans "Upload to DocumentCloud" %}</dd>
          <dd class="checklist-item">{% include "core/icons/check-circle-fill.svg" %}{% trans "Publish documents" %}</dd>
        </dl>
        {% else %}
        <div class="status unverified">
          {% include "core/icons/unverified.svg" %}
          <h3>{% trans "You are not a verified journalist, yet. Some features are restricted." %}</h3>
        </div>
        <dl class="features">
          <dt class="checklist-item">{% include "core/icons/lock.svg" %}{% trans "Locked features:" %}</dt>
          <dd class="checklist-item">{% include "core/icons/x-circle-fill.svg" %}{% trans "Upload to DocumentCloud" %}</dd>
          <dd class="checklist-item">{% include "core/icons/x-circle-fill.svg" %}{% trans "Publish documents" %}</dd>
        </dl>
        {% endif %}
      </div>
      {% if not verified %}
      <p class="info"><a href="#">Request individual verification</a> to publish your own documents.</p>
      {% endif %}
    </section>

    <section id="organizations">
      <header>
        <h2>{% trans "Your Organizations" %}</h2>
        <a href="{% url "organizations:list" %}" class="btn ghost">
          {% include "core/icons/organizations.svg" %}
          {% trans "Join an organization" %}
        </a>
        <a href="{% url "organizations:create" %}" class="btn ghost">
          {% include "core/icons/plus-circle.svg" %}
          {% trans "Start an organization" %}
        </a>
      </header>
      <div class="orgs">
      {% if potential_organizations %}
      <div class="list-header">
        <h3>{% trans "Pre-approved" %}</h3>
        <p>{% trans "Based on your email address, you're pre-approved to join:" %}</p>
      </div>
        {% for organization in potential_orgs %}
        <div class="invite">
          {% include "account/team_list_item.html" %}
          
          <form method="post" action="{% url "organizations:detail" slug=organization.slug %}" class="actions join">
            {% csrf_token %}
            <button class="button primary" name="action" value="join">
              <img src="{% static "icons/check.svg" %}">
              {% trans "Join" %}
            </button>
          </form>
        </div>
        {% endfor %}
      {% endif %}

      {% if pending_invitations %}
      <div class="list-header">
        <h3>{% trans "Open invitations" %}</h3>
        <p>{% trans "Organizations youâ€™ve been invited to join:" %}</p>
      </div>
        {% for invite in invitations %}
        <div class="invite">
          {% include "account/team_list_item.html" with organization=invite.organization %}
          
          <form method="post" action="{% url "organizations:invitation" uuid=invite.uuid %}" class="actions">
            {% csrf_token %}
            <button class="btn primary ghost" type="submit" name="action" value="accept">
              {% trans "Accept" %}
            </button>
            <button class="btn danger ghost" type="submit" name="action" value="reject">
              {% trans "Reject" %}
            </button>
          </form>
        </div>
        {% endfor %}
      {% endif %}

      {% if other_orgs %}
      <div class="list-header">
        <h3>{% trans "Membership" %}</h3>
        <p>{% trans "Organizations you've joined:" %}</p>
      </div>
        {% for org in other_orgs %}
        <div class="org">
          {% include "account/team_list_item.html" with organization=org %}
          <form method="post" action="{% url "organizations:detail" slug=org.slug %}" class="actions">
            {% csrf_token %}
            <button class="btn danger ghost" type="submit" name="action" value="leave">
              {% include "core/icons/sign-out.svg" %}
              {% trans "leave" %}
            </button>
          </form>
        </div>
        {% endfor %}
      {% endif %}

      {% if admin_orgs %}
      <div class="list-header">
        <h3>{% trans "Admin" %}</h3>
        <p>{% trans "Organizations you manage:" %}</p>
      </div>
      {% for org in admin_orgs %}
        <div class="org">
          {% include "account/team_list_item.html" with organization=org %}
          <div class="actions">
            {% if not org.verified_journalist %}
            <a class="btn primary" href="#">
              {% trans "Request verification" %}
            </a>
            {% endif %}
            <a class="btn ghost" href="{% url "organizations:manage-members" slug=org.slug %}">
              {% include "core/icons/gear.svg" %}
              {% trans "Manage" %}
            </a>
          </div>
        </div>
      {% endfor %}
      {% endif %}
      </div>

    </section>

    <section id="accounts">
      <header>
        <h2>{% trans "Your Connected Accounts" %}</h2>
        <a class="btn primary ghost" href="{% url "account_email" %}">
          {% include "core/icons/plus-circle.svg" %}
          {% trans "Connect an account" %}
        </a>
      </header>
      <div class="accounts">
        {% for email in emails %}
        <form class="email" action="{% url "account_email" %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="email" value="{{email.email}}" />
          {% include "core/icons/mail.svg" %}
          <span class="address">{{email.email}}</span>
          {% if not email.verified %}
          <button class="btn primary small" type="submit" name="action_send">
            {% trans "Confirm this email" %}
          </button>
          {% else %}
          <span class="badge verified">{% trans "Confirmed" %}</span>
          {% endif %}
          {% if email.primary %}
          <span class="badge">{% trans "Primary" %}</span>
          {% else %}
          <button class="btn small" type="submit" name="action_primary" {% if not email.verified %}disabled{% endif %}>
            {% trans "Make primary" %}
          </button>
          {% endif %}
          <button {% if email.primary %}disabled{% endif %} class="btn ghost danger" type="submit" name="action_remove">
            {% include "core/icons/trashcan.svg" %}
          </button>
        </form>
        {% endfor %}
      </div>
    </section>

    <section id="security">
      <h2>{% trans "Your Security Settings" %}</h2>
    </section>
  </div>
</main>


{% comment "delete this" %}
  <div class="_cls-largeContent">
    <div class="_cls-profileColumns">
      <div class="_cls-profileColumn">
        <div class="_cls-profileSection">
          <div class="_cls-profileInfo">
            <div class="_cls-profileAvatar">
              {% avatar user 37 %}
            </div>
            <div class="_cls-profileNames">
              <div class="_cls-profileName">
                {{ user.name }}
              </div>
              <div class="_cls-info">
                {{ user.username }}
              </div>
            </div>
          </div>
          {% if user == request.user %}
            <p>
              <a class="_cls-nostyle" href="{% url "users:update" %}">
                <div class="_cls-action">{% trans 'Edit profile' %}</div>
              </a>
            </p>
            <p>
              <a class="_cls-nostyle" href="{% url "socialaccount_connections" %}">
                <div class="_cls-action">{% trans 'Edit connected accounts' %}</div>
              </a>
            </p>
          {% endif %}
        </div>
        {% if user.individual_organization.verified_journalist %}
          <div class="_cls-orgStatus _cls-verified">
            Verified
          </div>
        {% endif %}

        <div class="_cls-organizationSection">
          <div class="_cls-mediumHeader">{% trans 'Organizations' %}</div>
          <div>
            <a class="_cls-action" href="{% url "organizations:list" %}">
              {% trans "View all organizations" %}
            </a>
          </div>
          {% if other_orgs.count > 0 %}
            <ul class="_cls-profList">
              {% for org in other_orgs.all %}
                <a href="{% url "organizations:detail" org.slug %}">
                  <li>
                    <div class="_cls-inlineAvatar">
                      {% avatar org 15 %}
                    </div>
                    {{ org.name }}
                  </li>
                </a>
              {% endfor %}
            </ul>
          {% else %}
            <div class="_cls-info">
              <p>{% trans 'You are not a member of any organization.' %}</p>
            </div>
          {% endif %}
        </div>

        <!-- Organizations you can join -->
        <div class="_cls-organizationSection" {% if not potential_organizations %} style="display: none;" {% endif %}>
          <div class="_cls-mediumHeader">{% trans 'Organizations you can join' %}</div>
          {% if potential_organizations %}
            <ul class="_cls-profList">
              {% for org in potential_organizations %}
                <a href="{% url "organizations:detail" org.slug %}">
                  <li>
                    <div class="_cls-inlineAvatar">
                      {% avatar org 15 %}
                    </div>
                    {{ org.name }}
                  </li>
                </a>
              {% endfor %}
            </ul>
          {% else %}
            <div class="_cls-info">
              <p>{% trans 'No organizations available to join at the moment.' %}</p>
            </div>
          {% endif %}
        </div>

      {% if pending_invitations %}
        <div class="_cls-organizationSection">
          <div class="_cls-mediumHeader">{% trans 'Pending Invitations' %}</div>
          <ul class="_cls-profList">
            {% for invite in pending_invitations %}
              <li>
                <a href="{% url 'organizations:invitation' invite.uuid %}">
                    {% blocktrans with org_name=invite.organization.name %}
                      Invite to join <strong>{{ org_name }}</strong>
                    {% endblocktrans %}
                </a>
                <span class="_cls-info" style="margin-left: 10px;">({{ invite.created_at|date:"Y-m-d" }})</span>
                </li>
              {% endfor %}
          </ul>
        </div>
      {% endif %}

      </div>

      <div class="_cls-planColumn">
        {% if user == request.user %}
          <div class="_cls-currentPlan">

            {% with subscription=user.individual_organization.subscription %}
              {% if subscription %}
                <div class="_cls-planInfo">
                  {% trans "Current plan" %}: <b>{{ subscription.plan.name }}</b>
                  {% if subscription.cancelled %}
                    <div class="_cls-info _cls-infoSpaced">
                      {% blocktrans with update_on=subscription.update_on|date:"m/d/Y" %}
                        Subscription ends on {{ update_on }}
                      {% endblocktrans %}
                    </div>
                  {% endif %}
                </div>
                <p>
                  <a class="_cls-nostyle" href="{% url "users:payment" %}">
                    <div class="_cls-action">{% trans 'Edit plans and payment' %}</div>
                  </a>
                </p>
              {% else %}
                <div class="_cls-planInfo">
                  {% trans "Current plan" %}: <b>{% trans "Free" %}</b>
                </div>
                <div class="_cls-actionSmall">
                  <a href="{% url "users:payment" %}">
                    <button>{% trans 'Upgrade' %}</button>
                  </a>
                </div>
              {% endif %}
            {% endwith %}

            <p>
              <a class="_cls-nostyle" href="{% url "users:receipts" %}">
                <div class="_cls-action">{% trans 'View receipts' %}</div>
              </a>
            </p>
          </div>
        {% endif %}

        {% if request.user.is_staff and request.user != user %}
          <form action="{% url "hijack:login_with_username" user.username %}" method="post" class="_cls-actionSmall">
            {% csrf_token %}
            <button type="submit">Hijack {{ user.username }}</button>
          </form>
        {% endif %}

        {% include "core/component/services.html" %}
      </div>

    </div>
  </div>
{% endcomment %}
{% endblock content %}
