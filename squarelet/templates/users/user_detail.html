{% extends "base.html" %}
{% load account airtable avatar i18n socialaccount static thumbnail %}

{% block title %}{% trans 'User' %}: {{ user.username }}{% endblock %}

{% block css %}
{# shared styles #}
<link rel="stylesheet" href="{% static "css/gps.css" %}" />
<link rel="stylesheet" href="{% static "css/team_list_item.css" %}" />

{# include any style tags in parent templates #}
{{ block.super }}

{# page-specific styles #}
<link rel="stylesheet" href="{% static "css/user_detail.css" %}" />
{% endblock css %}

{% block javascript %}
{# include scripts in parent templates #}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function closeDropdown(container) {
      container.classList.remove('dropdown-open');
      container.setAttribute('data-dropdown-open', 'false');
    }

    var containers = document.querySelectorAll('.dropdown-container');
    containers.forEach(function(container) {
      var anchor = container.querySelector('.dropdown-anchor');
      if (anchor) {
        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          var open = container.classList.contains('dropdown-open');
          if (open) {
            closeDropdown(container);
          } else {
            // Close all other dropdowns first
            containers.forEach(function(other) {
              if (other !== container) {
                closeDropdown(other);
              }
            });
            container.classList.add('dropdown-open');
            container.setAttribute('data-dropdown-open', 'true');
          }
        });
        // Ensure closed by default
        closeDropdown(container);
      }
    });

    // Close dropdown if clicking outside
    document.addEventListener('click', function(e) {
      containers.forEach(function(container) {
        if (!container.contains(e.target)) {
          closeDropdown(container);
        }
      });
    });
  });

  // Tab controller/Tab container logic
  document.querySelectorAll('.tab-controller').forEach(function(controller) {
    var container = controller.closest('.dropdown').querySelector('.tab-container');
    if (!container) return;

    function activateTab(tabName) {
      // Update controller tabs
      controller.querySelectorAll('.tab').forEach(function(tab) {
        var isActive = tab.getAttribute('data-tab') === tabName;
        tab.setAttribute('data-tab-active', isActive);
        tab.classList.toggle('tab-active', isActive);
      });
      // Update container tabs
      container.querySelectorAll('.tab').forEach(function(tab) {
        var isActive = tab.getAttribute('data-tab') === tabName;
        tab.setAttribute('data-tab-active', isActive);
        tab.classList.toggle('tab-active', isActive);
      });
    }

    // Click handler for controller tabs
    controller.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        var tabName = tab.getAttribute('data-tab');
        activateTab(tabName);
      });
    });

    // Initialize to first active tab
    var initial = controller.querySelector('.tab[data-tab-active="true"]');
    if (initial) {
      activateTab(initial.getAttribute('data-tab'));
    }
  });

  
</script>
{% endblock %}


{% block content %}
<article id="user_detail">
  <aside class="sidebar">
    <div class="account">
      <h2>{% trans "Your Account" %}</h2>
      <nav>
        <ul>
          <li>
            <a href="#profile" class="profile nav-item">
              {% include "core/icons/person.svg" %}
              {% trans "Profile" %}
            </a>
          </li>
          <li>
            <a href="#plan" class="plan nav-item">
              {% include "core/icons/credit-card.svg" %}
              {% trans "Plan" %}
            </a>
          </li>
          <li>
            <a href="#verification" class="verification nav-item">
              {% if verified %}
              {% include "core/icons/verification.svg" %}
              {% else %}
              {% include "core/icons/unverified.svg" %}
              {% endif %}
              {% trans "Verification" %}
            </a>
          </li>
          <li>
            <a href="#organizations" class="organization nav-item">
              {% include "core/icons/organization.svg" %}
              {% trans "Organizations" %}
            </a>
          </li>
          <li>
            <a href="#accounts" class="accounts nav-item">
              {% include "core/icons/mention.svg" %}
              {% trans "Accounts" %}
            </a>
          </li>
          <li>
            <a href="#security" class="security nav-item">
              {% include "core/icons/shield-lock.svg" %}
              {% trans "Security" %}
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <div class="content">
    <section id="profile">
      <header>
        <h2>{% trans "Your Profile" %}</h2>
        <div class="header-actions">
          <!-- Hide action until we support profile previews
          <a href="?public" class="btn ghost">
            {% include "core/icons/eye.svg" %}
            {% trans "View profile" %}
          </a>
          -->
          <a href="{% url "users:update" %}" class="btn ghost">
            {% include "core/icons/pencil.svg" %}
            {% trans "Edit profile" %}
          </a>
        </div>
      </header>
      <main class="profile">
        <div class="icon">
        {% if user.avatar %}
          <img src="{{ user.avatar.url }}" alt="{{user.name}}" />
        {% else %}
          {% include "core/icons/person-24.svg" %}
        {% endif %}
        </div>

        <div class="details">
          <h3>{% firstof user.name user.username %}</h3>
          {% if user.name %}<p class="user-detail">{{user.username}}</p>{% endif %}
          <p class="user-detail">Joined <time title="{{user.created_at|date:"c"}}" datetime="{{user.created_at|date:"c"}}">{{user.created_at|date:"F j, Y"}}</time></p>
        </div>
      </main>
    </section>

    <section id="plan">
      <header>
        <h2>{% trans "Your Plan" %}</h2>
        <div class="header-actions">
          <a href="{% url "users:receipts" %}" class="btn ghost">
            {% include "core/icons/log.svg" %}
            {% trans "View receipts" %}
          </a>
        </div>
      </header>
      <main class="plan">
        <div class="plan-overview">
          {% if not current_plan %}
            <p>You are using MuckRock&rsquo;s <span class="plan-name" id="free">Free</span> plan.</p>
            <a class="btn premium" href="{% url "users:payment" %}">Upgrade</a>
          {% else %}
            <p>You are subscribed to MuckRock&rsquo;s <span class="plan-name" id="{{current_plan.slug}}">{{current_plan.name}}</span> plan.</p>
            <a class="btn ghost" href="{% url "users:payment" %}">Change plan</a>
          {% endif %}
        </div>
        {% if current_plan %}
        <ul class="plan-details">
          {% if current_plan_next_charge_date %}
          <li class="plan-detail plan-next-charge">
            <span class="icon">{% include "core/icons/calendar.svg" %}</span>
            <span class="label">
              Subscription {% if current_plan_cancelled %}ends{% else %}renews{% endif %} on <time title="{{current_plan_next_charge_date|date:"c"}}" datetime="{{current_plan_next_charge_date|date:"c"}}">{{current_plan_next_charge_date|date:"F j, Y"}}</time></span>
          </li>
          {% endif %}
          {% if current_plan_card %}
          <li class="plan-detail plan-card">
            <span class="icon">{% include "core/icons/credit-card.svg" %}</span>
            <span class="label">{{current_plan_card.brand}} ending in {{current_plan_card.last4}}</span>
          </li>
          {% endif %}
        </ul>
        {% endif %}
      </main>
    </section>

    <section id="verification">
      <header>
        <h2>{% trans "Your Verification" %}</h2>
        <a href="https://help.muckrock.com/Request-verification-19ef8892696381dba944e17e14938433" class="btn ghost" target="_blank" rel="noopener noreferer">
          {% include "core/icons/book.svg" %}
          {% trans "Learn about verification" %}
        </a>
      </header>

      <main class="verification-status">
        {% if verified %}
        <div class="status verified">
          {% include "core/icons/verified-24.svg" %}
          <h3>{% trans "You are a verified journalist." %}</h3>
        </div>
        <dl class="unlocked features">
          <dt class="checklist-item">{% include "core/icons/unlock.svg" %}{% trans "Unlocked features:" %}</dt>
          <dd class="checklist-item">{% include "core/icons/check-circle-fill.svg" %}{% trans "Upload to DocumentCloud" %}</dd>
          <dd class="checklist-item">{% include "core/icons/check-circle-fill.svg" %}{% trans "Publish documents" %}</dd>
        </dl>
        {% else %}
        <div class="status unverified">
          {% include "core/icons/unverified-24.svg" %}
          <h3>{% trans "You are not a verified journalist. Some features are restricted." %}</h3>
          <p class="help-text">Request newsroom verification for one of your organizations, or <a href="{% airtable_verification_url %}">request journalist verification for yourself</a>, to upload and publish documents.</p>
        </div>
        <dl class="locked features">
          <dt class="checklist-item">{% include "core/icons/lock.svg" %}{% trans "Locked features:" %}</dt>
          <dd class="checklist-item">{% include "core/icons/x-circle-fill.svg" %}{% trans "Upload to DocumentCloud" %}</dd>
          <dd class="checklist-item">{% include "core/icons/x-circle-fill.svg" %}{% trans "Publish documents" %}</dd>
        </dl>
        {% endif %}
      </main>
    </section>

    <section id="organizations">
      <header>
        <h2>{% trans "Your Organizations" %}</h2>
        <div class="header-actions">
          <a href="{% url "organizations:list" %}" class="btn ghost">
            {% include "core/icons/search.svg" %}
            {% trans "Search organizations" %}
          </a>
          <a href="{% url "organizations:create" %}" class="btn ghost">
            {% include "core/icons/plus-circle.svg" %}
            {% trans "Create organization" %}
          </a>
        </div>
      </header>
      <main class="orgs">
        {% if potential_organizations %}
        <div class="org-list">
          <header class="org-list-header">
            <h3>{% trans "Pre-approved" %}</h3>
            <p>{% trans "Based on your email address, you're pre-approved to join:" %}</p>
          </header>
          {% for organization in potential_organizations %}
            <div class="invite">
              {% include "account/team_list_item.html" with organization=organization %}
              <form method="post" action="{% url "organizations:detail" slug=organization.slug %}" class="actions join">
                {% csrf_token %}
                <button class="small btn primary" name="action" value="join">
                  <img src="{% static "icons/check.svg" %}">
                  {% trans "Join" %}
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {% if pending_invitations %}
        <div class="org-list">
          <header class="org-list-header">
            <h3>{% trans "Open invitations" %}</h3>
            <p>{% trans "Organizations you’ve been invited to join:" %}</p>
          </header>
          {% for invite in invitations %}
            <div class="invite">
              {% include "account/team_list_item.html" with organization=invite.organization %}
              <form method="post" action="{% url "organizations:invitation" uuid=invite.uuid %}" class="actions">
                {% csrf_token %}
                <button class="small btn primary" type="submit" name="action" value="accept">
                  {% trans "Accept" %}
                </button>
                <button class="small btn danger ghost" type="submit" name="action" value="reject">
                  {% trans "Reject" %}
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {% if admin_orgs %}
        <div class="org-list">
          <header class="org-list-header">
            <h3>{% trans "Admin" %}</h3>
            <p>{% trans "Organizations you manage:" %}</p>
          </header>
          {% for org in admin_orgs %}
            <div class="org">
              {% include "account/team_list_item.html" with organization=org %}
              <div class="actions">
                {% if not org.verified_journalist %}
                <a class="btn ghost small" href="{% airtable_verification_url org %}">
                  {% trans "Request verification" %}
                </a>
                {% endif %}
                <a class="btn ghost small" href="{% url "organizations:manage-members" slug=org.slug %}">
                  {% include "core/icons/gear.svg" %}
                  {% trans "Manage" %}
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {% if other_orgs %}
        <div class="org-list">
          <header class="org-list-header">
            <h3>{% trans "Membership" %}</h3>
            <p>{% trans "Organizations you've joined:" %}</p>
          </header>
          {% for org in other_orgs %}
            <div class="org">
              {% include "account/team_list_item.html" with organization=org %}
              <form method="post" action="{% url "organizations:detail" slug=org.slug %}" class="actions">
                {% csrf_token %}
                <button class="btn danger ghost small" type="submit" name="action" value="leave">
                  {% include "core/icons/sign-out.svg" %}
                  {% trans "Leave" %}
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {% if not other_orgs and not admin_orgs and not pending_invitations and not potential_organizations %}
        <div class="org-empty">
          <p>
            {% blocktrans %}
            Create or join an organization to collaborate with other MuckRock users
            {% endblocktrans %}
          </p>
        </div>
        {% endif %}
      </main>
    </section>

    <section id="accounts">
      <header>
        <h2>{% trans "Your Connected Accounts" %}</h2>
        <div class="dropdown-container" data-dropdown-open="false" >
          <a class="btn primary ghost {% if settings.ENABLE_SOCIAL_LOGINS %}dropdown-anchor{% endif %}" href="{% url "account_email" %}">
            {% include "core/icons/plus-circle.svg" %}
            {% trans "Connect an account" %}
          </a>
          {% if settings.ENABLE_SOCIAL_LOGINS %}
          {% get_providers as socialaccount_providers %}
          <div class="dropdown">
            <div class="connect-account-dropdown card">
              <header>
                <ul class="tab-controller">
                  <li class="tab tab-active" data-tab="email" data-tab-active="true">
                    Email
                  </li>
                  {% for provider in socialaccount_providers %}
                  <li class="tab" data-tab="{{provider.id}}" data-tab-active="false">
                    {{provider.name}}
                  </li>
                  {% endfor %}
                </ul>
              </header>
              <div class="tab-container">
                <div class="tab tab-active" data-tab="email" data-tab-active="true">
                  <form class="connect-account-form" method="POST" action="{% url 'account_email' %}">
                    {% csrf_token %}
                    <input class="email-input" type="email" name="email" placeholder="Enter your email" required />
                    <button class="primary btn" type=submit" name="action_add">Add Email</button>
                    <p class="help-text">
                      {% blocktrans %}
                      When you connect an email address, you can use it as a sign-in method, receive notifications to it, and use it to auto-join organizations that share your domain.
                      {% endblocktrans %}
                    </p>
                  </form>
                </div>
                {% for provider in socialaccount_providers %}
                <div class="tab" data-tab="{{provider.id}}" data-tab-active="false">
                  <form class="connect-account-form" method="POST" action="{% provider_login_url provider.id process="connect" %}">
                    {% csrf_token %}
                    <button type=submit" class="primary btn">Connect with {{provider.name}}</button>
                    <p class="help-text">
                      {% blocktrans %}
                      When you connect a {{provider.name}} account, you can use your account as a sign-in method.
                      {% endblocktrans %}                      
                    </p>
                  </form>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </header>
      <main class="accounts">
        {% for email in emails %}
        <div class="email account">
          <div class="account-detail">
            <span class="icon">{% include "core/icons/mail.svg" %}</span>
            <h3 class="label">{{email.email}}</h3>
          </div>
          <form class="email-actions" action="{% url "account_email" %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="email" value="{{email.email}}" />
            {% if not email.verified %}
            <button class="btn primary small" type="submit" name="action_send">
              {% trans "Confirm this email" %}
            </button>
            {% else %}
            <span class="badge green">{% trans "Confirmed" %}</span>
            {% endif %}
            {% if email.primary %}
            <span class="badge blue">{% trans "Primary" %}</span>
            {% else %}
            <button class="btn small" type="submit" name="action_primary" {% if not email.verified %}disabled{% endif %}>
              {% trans "Make primary" %}
            </button>
            {% endif %}
            <button {% if email.primary %}disabled{% endif %} class="btn ghost danger" type="submit" name="action_remove">
              {% include "core/icons/trashcan.svg" %}
            </button>
          </form>
        </div>
        {% endfor %}
        {% if settings.ENABLE_SOCIAL_LOGINS %}
        {% get_social_accounts user as accounts %}
        {% for google_account in accounts.google %}
          <div class="social account">
            <div class="account-detail">
              <div class="icon">{% include "core/icons/google.svg" %}</div>
              <div class="account-detail-text">
                <h3 class="provider-label">{{google_account.get_provider}}</h3>
                <p class="provider-account">{{google_account.get_provider_account}}</p>
              </div>
              <div class="account-status">
                <span class="badge green">{% trans "Connected" %}</span>
              </div>
            </div>
            <div class="account-actions">
              <form method="POST" action="{% url 'socialaccount_connections' %}">
                {% csrf_token %}
                <input type="hidden" name="account" value="{{google_account.pk}}" />
                <button type="submit" class="ghost danger btn" title="Disconnect {{google_account.provider}} account">
                  {% include "core/icons/trashcan.svg" %}
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
        {% for github_account in accounts.github %}
          <div class="social account">
            <div class="account-detail">
              <div class="icon">{% include "core/icons/github.svg" %}</div>
              <div class="account-detail-text">
                <h3 class="provider-label">{{github_account.get_provider}}</h3>
                <p class="provider-account">{{github_account.get_provider_account}}</p>
              </div>
              <div class="account-status">
                <span class="badge green">{% trans "Connected" %}</span>
              </div>
            </div>
            <div class="account-actions">
              <form method="POST" action="{% url 'socialaccount_connections' %}">
                {% csrf_token %}
                <input type="hidden" name="account" value="{{github_account.pk}}" />
                <button type="submit" class="ghost danger btn" title="Disconnect {{github_account.provider}} account">
                  {% include "core/icons/trashcan.svg" %}
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
        {% endif %}
      </main>
    </section>

    <section id="security">
      <header>
        <h2>{% trans "Your Security Settings" %}</h2>
        <a class="btn primary ghost" href="https://help.muckrock.com/Two-Factor-Authentication-1f9f8892696380e59857c19341a324af" target="_blank" rel="noopener noreferer">
          {% include "core/icons/book.svg" %}
          {% trans "Security best practices" %}
        </a>
      </header>
      <main class="security">
        <div class="password">
          <h3>{% trans "Password" %}</h3>
          <a href="{% url "account_change_password" %}" class="small btn ghost primary">{% trans "Change password" %}</a>
        </div>
        <div class="mfa">
          <div class="mfa-overview">
            <h3>{% trans "Two-factor authentication" %}</h3>
            <div class="mfa-active">
              {% if is_mfa_enabled %}
              <span class="badge green">{% trans "Enabled" %}</span>
              <a class="small btn ghost" href="{% url "mfa_deactivate_totp" %}">{% trans "Disable two-factor auth" %}</a>
              {% else %}
              <a class="small btn ghost" href="{% url "mfa_activate_totp" %}">{% trans "Enable two-factor auth" %}</a>
              {% endif %}
            </div>
          </div>
          {% if is_mfa_enabled %}
            <div class="recovery-codes">
              <dl class="status">
                <dt>{% trans "Recovery codes" %}</dt>
                <dd>
                  There {{unused_code_count|pluralize:"is,are"}} {{ unused_code_count }} out of {{ RECOVERY_CODE_COUNT }} recovery codes available.
                </dd>
              </dl>
              <div class="actions">
                <a href="{% url "mfa_view_recovery_codes" %}" class="btn ghost small">
                  {% include "core/icons/eye.svg" %}
                  {% trans "View" %}
                </a>
                <a href="{% url "mfa_generate_recovery_codes" %}" class="btn ghost small">
                  {% include "core/icons/sync.svg" %}
                  {% trans "Generate" %}
                </a>
                <a href="{% url "mfa_download_recovery_codes" %}" class="btn ghost small">
                  {% include "core/icons/download.svg" %}
                  {% trans "Download" %}
                </a>
              </div>
            </div>
            {% endif %}
        </div>

        
      </main>
    </section>
  </div>
</article>
{% endblock content %}
