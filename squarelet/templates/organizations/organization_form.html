{% extends "base.html" %}
{% load i18n django_vite crispy_forms_tags planinfo %}

{% block title %}{{ organization.reference_name }}{% endblock %}

{% block vite %}
{{ block.super }}
{% vite_asset "frontend/views/organization_form.ts" %}
{% endblock %}

{% block content %}
<article id="organization-form">
  <aside class="sidebar">
    <header>
      <a href="{{ organization.get_absolute_url }}" class="btn small ghost primary">
        {% include "core/icons/chevron-left.svg" %}
        {% trans "Back to team overview" %}
      </a>
      <h1>{{ organization.name }}</h1>
      <h2>{% trans "Edit profile" %}</h2>
    </header>
  </aside>

  <div class="content">
    <section id="details">
      <header>
        <div class="title">
          <h2>{% trans "Organization Details" %}</h2>
          <p>{% trans "Update your organization information" %}</p>
        </div>
      </header>

      <form method="POST" action="{% url "organizations:update" slug=organization.slug %}" class="form card">
        {% crispy form form.helper %}
        <button type="submit" class="btn primary">
          {% trans "Save changes" %}
        </button>
      </form>
    </section>

    <section id="protected">
      <header>
        <div class="title">
          <h2>{% trans "Protected fields" %}</h2>
          <p>
            {% trans "Changes to these fields require approval by MuckRock staff" %}
          </p>
        </div>
      </header>

      {% if pending_change_requests %}
      <div class="card" id="pending-requests">
        <h3>{% trans "Pending Change Requests" %}</h3>
        <p>{% trans "You have the following change requests awaiting staff approval:" %}</p>
        {% for change in pending_change_requests %}
        <dl>
          <dt>{% trans "Requested on" %}</dt>
          <dd>{{ change.created_at|date:"SHORT_DATE_FORMAT" }}</dd>

          <dt>{% trans "Status" %}</dt>
          <dd>{{ change.get_status_display }}</dd>

          {% if change.name %}
          <dt>{% trans "Name" %}</dt>
          <dd>{{ change.name }}</dd>
          {% endif %}

          {% if change.slug %}
          <dt>{% trans "Slug" %}</dt>
          <dd>{{ change.slug }}</dd>
          {% endif %}

          {% if change.city %}
          <dt>{% trans "City" %}</dt>
          <dd>{{ change.city }}</dd>
          {% endif %}

          {% if change.state %}
          <dt>{% trans "State" %}</dt>
          <dd>{{ change.get_state_display }}</dd>
          {% endif %}

          {% if change.country %}
          <dt>{% trans "Country" %}</dt>
          <dd>{{ change.get_country_display }}</dd>
          {% endif %}

          {% if change.explanation %}
          <dt>{% trans "Explanation" %}</dt>
          <dd>{{ change.explanation }}</dd>
          {% endif %}

          {% if user.is_staff %}
          <h3>{% trans "Actions" %}</h3>
          <div>
            <form method="POST" action="{% url 'organizations:review-profile-change' slug=organization.slug pk=change.pk %}" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="accept">
              <button type="submit" class="btn small primary">
                {% trans "Accept" %}
              </button>
            </form>
            <form method="POST" action="{% url 'organizations:review-profile-change' slug=organization.slug pk=change.pk %}" style="display: inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="reject">
              <button type="submit" class="btn small">
                {% trans "Reject" %}
              </button>
            </form>
          </div>
          {% endif %}
        </dl>
        {% endfor %}
      </div>
      {% endif %}
      <form method="POST" action="{% url "organizations:request-profile-change" slug=organization.slug %}" class="form card">
        {% crispy profile_change_form profile_change_form.helper %}
        
        <button type="submit" class="btn primary">
          {% if user.is_staff %}
          {% trans "Save changes" %}
          {% else %}
          {% trans "Request changes" %}
          {% endif %}
        </button>
      </form>
    </section>
  </div>

</article>
{% endblock content %}

{% comment %}
  <div class="_cls-content">
    <h1>{{ organization.reference_name }}</h1>
    {% if failed_receipt_emails %}
      <p>Warning: there were errors sending email to the following email addresses in your receipt emails:</p>
      <ul>
        {% for email in failed_receipt_emails %}
          <li> {{ email.email }} </li>
        {% endfor %}
      </ul>
    {% endif %}
    <div class="_cls-planInfo">
      {% trans "Current plan" %}: <b>{{ organization.plan|default:"Free" }}</b>
      {% if organization.subscription.cancelled %}
        <div class="_cls-info _cls-infoSpaced">
          {% blocktrans with update_on=organization.subscription.update_on|date:"m/d/Y" %}
            Subscription ends on {{ update_on }}
          {% endblocktrans %}
        </div>
      {% endif %}
    </div>
    <form id="stripe-form" method="post" enctype="multipart/form-data">
      {% crispy form form.helper %}

      {% if form.stripe_token %}
        <div id="_id-planProjection" class="_cls-planProjection">
          <b>Cost: <span id="_id-totalCost"></span></b>
          <div class="_cls-breakdown" id="_id-costBreakdown"></div>
        </div>
        <div id="card-container">
          <h3 class="_cls-smallHeading">{% blocktrans %}Billing information{% endblocktrans %}</h3>
          <div class="_cls-field">
            <div id="card-element" class="_cls-fieldInput"></div>
          </div>
          <!-- Used to display Element errors. -->
          <div id="card-errors" role="alert"></div>
        </div>
      {% endif %}

      <div class="control-group" style="margin-top: 2em;">
        <div class="_cls-actionSmall">
          <button type="submit" class="btn">{% trans 'Update' %}</button>
          <a href="{{ organization.get_absolute_url }}" class="_cls-altAction">
            {% trans 'Cancel' %}
          </a>
        </div>
      </div>

    </form>
  </div>
  {% planinfo organization=organization %}
{% endcomment %}
