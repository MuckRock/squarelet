{% extends "layouts/sidebar_layout.html" %}
{% load django_vite static thumbnail avatar i18n airtable %}

{% block title %}{% trans 'Organization' %}: {{ organization.name }}{% endblock %}

{% block vite %}
{{ block.super }}
{% vite_asset "frontend/views/organization_detail.ts" %}
{% endblock %}

{% block layout_id %}organization_detail{% endblock %}

{% block header %}
  <header>
    <h1>{% trans "Organization" %}</h1>
  </header>
  {% if request.user.is_staff %}
    <div class="staff-toolbar">
      <h3>{% trans "Staff control panel" %}</h3>
      <div class="staff-actions">
        <a href="{% url 'admin:organizations_organization_change' organization.pk %}" class="btn ghost" target="_blank">
          {% trans "View in Django admin" %}
        </a>
        <a href="{% url 'organizations:merge' %}" class="btn ghost">
          {% trans "Merge organization" %}
        </a>
        {% if organization.plan.wix %}
          <form method="post" style="display: inline;">
            {% csrf_token %}
            <button class="btn caution" type="submit" name="action" value="sync_wix">
              {% trans "Sync Wix" %}
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block sidebar %}
  <ul>
    <li>
      <a href="#profile" class="nav-item">
        {% include 'core/icons/organization.svg' %}
        {% trans "Profile" %}
      </a>
    </li>
    {% if user.is_staff or is_admin or is_member %}
    <li>
      <a href="#plan" class="nav-item">
        {% include "core/icons/credit-card.svg" %}
        {% trans "Plan" %}
      </a>
    </li>
    {% endif %}
    <li>
      <a href="#members" class="nav-item">
        {% include "core/icons/people.svg" %}
        {% if is_member %}
        {% trans "Members" %}
        {% else %}
        {% trans "Admins" %}
        {% endif %}
      </a>
    </li>
    <li>
      <a href="#verification" class="nav-item">
        {% if organization.verified_journalist %}
        {% include "core/icons/verification.svg" %}
        {% else %}
        {% include "core/icons/unverified.svg" %}
        {% endif %}
        {% trans "Verification" %}
      </a>
    </li>
    {% comment %}
    # We're hiding this section for now, until we
    # add more features for controlling org security.
    {% if user.is_staff or is_admin or is_member %}
    <li>
      <a href="#security" class="nav-item">
        {% include "core/icons/shield-lock.svg" %}
        {% trans "Security" %}
      </a>
    </li>
    {% endif %}
    {% endcomment %}
  </ul>
{% endblock sidebar %}

{% block main %}
    <section id="profile">
      <header>
        <h2>{% trans "Profile" %}</h2>
        {% if is_admin or request.user.is_staff %}
        <div class="header-actions">
          <a href="{% url 'organizations:update' organization.slug %}" class="btn ghost primary">
            {% include "core/icons/pencil.svg" %}
            {% trans "Edit profile" %}
          </a>
        </div>
        {% endif %}
      </header>
      <main class="profile">
        <div class="icon">
          {% with avatar=organization.avatar %}
          {% if avatar %}
            {% thumbnail avatar "240x240" crop="center" as img %}
            <img src="{{ img.url }}" />
            {% endthumbnail %}
          {% else %}
            {% include 'core/icons/people-24.svg' %}
          {% endif %}
          {% endwith %}
        </div>
        <div class="details details-padded">
          <h3>{{ organization.name }}</h3>
          {% if organization.verified_journalist or organization.city or organization.state or organization.country %}
          <div class="details">
            {% if organization.verified_journalist %}
              <div class="badge green">
                {% include "core/icons/verification.svg" %}
                {% trans "Verified" %}
              </div>
            {% endif %}
            {% if organization.city or organization.state or organization.country %}
              <p class="user-detail">
                {% if organization.city %}{{ organization.city }}{% endif %}{% if organization.city and organization.state %}, {% endif %}{% if organization.state %}{{ organization.get_state_display }}{% endif %}{% if organization.country and organization.country != 'US' %}, {{ organization.get_country_display }}{% endif %}
              </p>
            {% endif %}
          </div>
          {% endif %}
          {% if organization.about %}
            <p class="org-about">{{ organization.about }}</p>
          {% endif %}
        </div>
      </main>
    </section>

    {% if user.is_staff or is_admin or is_member %}
    <section id="plan">
      <header>
        <h2>{% trans "Plan" %}</h2>
        {% if user.is_staff or is_admin %}
        <div class="header-actions">
          <a href="{% url 'select_plan' %}" class="btn ghost primary">
            {% include "core/icons/list-unordered.svg" %}
            {% trans "View all plans" %}
          </a>
          <a href="{% url 'users:receipts' username=user.username %}" class="btn ghost primary">
            {% include "core/icons/log.svg" %}
            {% trans "View receipts" %}
          </a>
        </div>
        {% endif %}
      </header>
      <main class="plan">
        {% if current_plan %}
          <div class="plan-overview">
            <p>{% trans "This org is using MuckRock's" %} <span class="plan-name" id="{{ current_plan.slug }}">{% trans current_plan.name %}</span> {% trans "plan." %}</p>
            {% if user.is_staff or is_admin %}
            <a href="{% url 'organizations:payment' organization.slug %}" class="btn primary ghost">
              {% trans "Billing settings" %}
            </a>
            {% endif %}
          </div>
          <ul class="plan-details">
            {% if current_plan_next_charge_date %}
              <li class="plan-detail plan-next-charge">
                <span class="icon">{% include "core/icons/calendar.svg" %}</span>
                <span class="label">
                  Subscription {% if current_plan_cancelled %}ends{% else %}renews{% endif %} on <time title="{{current_plan_next_charge_date|date:"c"}}" datetime="{{current_plan_next_charge_date|date:"c"}}">{{current_plan_next_charge_date|date:"F j, Y"}}</time></span>
              </li>
            {% endif %}
            {% if current_plan_card %}
              <li class="plan-detail plan-card">
                <span class="icon">{% include "core/icons/credit-card.svg" %}</span>
                <span class="label">{{current_plan_card.brand}} ending in {{current_plan_card.last4}}</span>
              </li>
            {% endif %}
          </ul>
          {% if current_plan.benefits %}
            <ul class="plan-benefits checklist">
              {% for benefit in current_plan.benefits %}
              <li class="checklist-item">
                <span class="icon">
                  {% include "core/icons/checkmark.svg" %}
                </span>
                <span class="text">{{ benefit }}</span>
              </li>
              {% endfor %}
            </ul>
          {% endif %}
        {% elif upgrade_plan %}
        <div class="plan-upgrade">
          <div class="plan-overview">
            <p>{% trans "This org is using MuckRock's" %} <span class="plan-name" id="free">{% trans "Free" %}</span> {% trans "plan." %}</p>
            {% if user.is_staff or is_admin %}
            <a href="{% url 'organizations:payment' organization.slug %}" class="btn premium ghost">
              {% include "core/icons/premium.svg" %}
              {% trans "Upgrade" %}
            </a>
            {% endif %}
          </div>
          {% if is_admin or user.is_staff %}
          <hr class="divider" />
          {% if not upgrade_plan.benefits %}
          <p>Upgrade to our <a class="plan-name" href="{% url "plan_detail" pk=upgrade_plan.id slug=upgrade_plan %}">{{upgrade_plan.name}}</a> plan for more.</p>
          {% else %}
          <p>Upgrade to our <a class="plan-name" href="{% url "plan_detail" pk=upgrade_plan.id slug=upgrade_plan %}">{{upgrade_plan.name}}</a> plan for additional benefits and features:</p>
          <ul class="plan-benefits checklist">
            {% for benefit in upgrade_plan.benefits %}
            <li class="checklist-item">
              <span class="icon">
                {% include "core/icons/checkmark.svg" %}
              </span>
              <span class="text">{{ benefit }}</span>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
          {% endif %}
        </div>
        {% endif %}
      </main>
    </section>
    {% endif %}

    <section id="members">
      <header>
        <h2>
          {% if is_member %}
            {% blocktrans count count=member_count %}
              {{ count }} Member
            {% plural %}
              {{ count }} Members
            {% endblocktrans %}
          {% else %}
            {% blocktrans count count=admin_count %}
              {{ count }} Admin
            {% plural %}
              {{ count }} Admins
            {% endblocktrans %}
          {% endif %}
        </h2>
        <div class="header-actions">
          {% if is_admin or user.is_staff %}
            <a href="{% url 'organizations:manage-members' organization.slug %}#invite" class="btn ghost primary">
              {% include "core/icons/plus-circle.svg" %}
              {% trans "Invite members" %}
            </a>
            <a href="{% url 'organizations:manage-members' organization.slug %}" class="btn ghost primary">
              {% include "core/icons/people.svg" %}
              {% trans "Manage members" %}
            </a>

          {% endif %}
          {% if is_member %}
            <form class="_cls-infoSpaced" method="post">
              {% csrf_token %}
              <button class="btn danger ghost" name="action" value="leave">
                {% include "core/icons/sign-out.svg" %}
                {% trans 'Leave org' %}
              </button>
            </form>
          {% elif requested_invite %}
            <p>{% trans 'You have requested an invite.' %}</p>
          {% elif rejected_invite %}
            <p>{% trans 'Your request to join this organization was rejected. Please contact an admin if this is a mistake and you need to be added to this organization.' %}</p>
          {% elif user.is_authenticated and not is_member %}
            <form method="post">
              {% csrf_token %}
              <button class="btn primary" name="action" value="join" id="join-org-button">
                {% include "core/icons/plus-circle.svg" %}
                {% if can_auto_join %}
                  {% trans "Join" %}
                {% else %}
                  {% trans "Request to join" %}
                {% endif %}
              </button>
            </form>
            {% include "organizations/join_request_modal.html" %}
          {% endif %}
        </div>
      </header>
      <main class="members">
        {% if pending_requests and pending_requests.count > 0 %}
          <div class="notification-banner blue">
            <div class="banner-content">
              <span class="icon">{% include "core/icons/person-add.svg" %}</span>
              <div class="banner-text">
                <strong>
                  {% blocktrans count count=pending_requests.count %}
                    You have {{ count }} pending join request
                  {% plural %}
                    You have {{ count }} pending join requests
                  {% endblocktrans %}
                </strong>
                <p>{% trans "Review and approve requests to add new members to your organization." %}</p>
              </div>
              <a href="{% url 'organizations:manage-members' organization.slug %}#requests" class="btn primary">
                {% trans "Review requests" %}
              </a>
            </div>
          </div>
        {% endif %}
        {% if pending_invitations and pending_invitations.count > 0 %}
          <div class="notification-banner blue">
            <div class="banner-content">
              <span class="icon">{% include "core/icons/mail.svg" %}</span>
              <div class="banner-text">
                <strong>
                  {% blocktrans count count=pending_invitations.count %}
                    You have {{ count }} pending invitation
                  {% plural %}
                    You have {{ count }} pending invitations
                  {% endblocktrans %}
                </strong>
                <p>{% trans "Resend and revoke outstanding invitations." %}</p>
              </div>
              <a href="{% url 'organizations:manage-members' organization.slug %}#pending" class="btn primary">
                {% trans "Review invitations" %}
              </a>
            </div>
          </div>
        {% endif %}
        {% if users|length > 0 %}
          <div class="user-list">
            {% for user in users %}
              {% with membership=user.org_membership_list.0 %}
                {% include "organizations/user_list_item.html" %}
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="help-text">{% trans "This organization has no members." %}</p>
        {% endif %}
      </main>
    </section>

    <section id="verification">
      <header>
        <h2>{% trans "Verification" %}</h2>
        <a target="_blank" rel="noopener noreferrer" href="https://help.muckrock.com/Request-verification-19ef8892696381dba944e17e14938433" class="btn ghost primary">
          {% include "core/icons/book.svg" %}
          {% trans "Learn about verification" %}
        </a>
      </header>
      <main class="verification-status">
        {% if organization.verified_journalist %}
          <div class="status verified">
            {% include "core/icons/verified-24.svg" %}
            <h3>{% trans "This organization is verified." %}</h3>
            <p class="help-text">{% trans "This organization has been verified as a newsroom with access to additional reporting and publishing tools." %}</p>
          </div>
        {% else %}
          <div class="status unverified">
            {% include "core/icons/unverified-24.svg" %}
            <h3>{% trans "This organization is not verified." %}</h3>
            {% if show_verification_request and is_member or is_admin or request.user.is_staff %}
              <p class="help-text">{% trans "Request newsroom verification to access additional reporting and publishing tools." %}</p>
              <a target="_blank" rel="noopener noreferrer" class="btn primary" href="{% airtable_verification_url organization %}">
                {% trans "Request verification" %}
              </a>
            {% endif %}
          </div>
        {% endif %}
        <div class="features">
          <p>
            {% blocktrans %}
            Verified newsrooms have access to additional reporting and publishing tools. Before you can upload documents to DocumentCloud, or access other advanced features, you may need to be in a verified newsroom.
            {% endblocktrans %}
            <a target="_blank" rel="noopener noreferrer" href="https://help.muckrock.com/Request-verification-19ef8892696381dba944e17e14938433">{% trans "Learn more" %}</a>
          </p>
        </div>
      </main>
    </section>

    {% comment %}
    # This section is not yet ready, since the features aren't supported yet.
    # We're keeping this ready for when we need it.
    {% if user.is_staff or is_admin or is_member %}
    <section id="security">
      <header>
        <h2>{% trans "Security Settings" %}</h2>
        <a target="_blank" rel="noopener noreferrer" class="btn primary ghost" href="https://help.muckrock.com">
          {% include "core/icons/book.svg" %}
          {% trans "Security best practices" %}
        </a>
      </header>
      <main class="security">
        <div class="security-setting">
          <h3>{% trans "Join requests" %}</h3>
          <span class="badge green">{% trans "Enabled" %}</span>
        </div>
        <p class="help-text">{% trans "Users can request to join this organization" %}</p>

        <div class="security-setting">
          <h3>{% trans "Auto-join via verified email" %}</h3>
          {% if security_settings.allow_auto_join %}
            <span class="badge green">{% trans "Enabled" %}</span>
          {% else %}
            <span class="badge">{% trans "Disabled" %}</span>
          {% endif %}
        </div>
        {% if security_settings.has_email_domains %}
          <p class="help-text">
            <a href="{% url 'organizations:manage-domains' organization.slug %}">{% trans "Manage email domains" %}</a>
          </p>
        {% else %}
          <p class="help-text">
            {% if organization.verified_journalist %}
              <a href="{% url 'organizations:manage-domains' organization.slug %}">{% trans "Add email domains to allow auto-join" %}</a>
            {% else %}
              {% trans "Verify your organization to manage email domains" %}
            {% endif %}
          </p>
        {% endif %}

        <div class="security-setting">
          <h3>{% trans "Require two-factor authentication" %}</h3>
          <span class="badge">{% trans "Not yet implemented" %}</span>
        </div>
        <p class="help-text">{% trans "Coming soon" %}</p>
      </main>
    </section>
    {% endif %}
    {% endcomment %}
{% endblock main %}

{% block extra_javascript %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const joinButton = document.getElementById('join-org-button');
    if (joinButton) {
      const backdrop = document.getElementById('join-request-modal-backdrop');

      // Intercept link click and show modal instead
      joinButton.addEventListener('click', function(e) {
        e.preventDefault();
        backdrop.classList.remove('_cls-hide');
        document.body.style.overflow = 'hidden';
      });

      // Close modal on backdrop click
      backdrop.addEventListener('click', function(e) {
        if (e.target === backdrop) {
          backdrop.classList.add('_cls-hide');
          document.body.style.overflow = '';
        }
      });

      // Close modal on close button click
      const closeButtons = backdrop.querySelectorAll('[data-dismiss="modal"]');
      closeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          backdrop.classList.add('_cls-hide');
          document.body.style.overflow = '';
        });
      });

      // Close modal on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !backdrop.classList.contains('_cls-hide')) {
          backdrop.classList.add('_cls-hide');
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>
{% endblock %}
